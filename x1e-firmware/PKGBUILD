pkgname="x1e-firmware"
pkgdesc="Linux firmware for Snapdragon X devices"
pkgver=20240811
pkgrel=3
arch=("any")
options=('!strip')
url="https://git.kernel.org/?p=linux/kernel/git/firmware/linux-firmware.git;a=summary"
license=('GPL2' 'GPL3' 'custom')
makedepends=('git')
options=(!strip)
pkgname=(x1e-firmware)
_srcdir=linux-firmware

_backports=('82318c966fd1af87044299d34611751c76f70927')

source=("git+https://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git"
        "git+https://github.com/anonymix007/x1e-firmware"
        "dracut.conf.d-x1e-firmware.conf")
sha256sums=('SKIP'
            'SKIP'
            '7e0fe9ae0b6690567fb51d97997f967b5903af13f5d567f810f298eeb0d3e32c')

prepare() {
  cd linux-firmware
  git checkout tags/${pkgver}
  local _c
  for _c in "${_backports[@]}"; do
    git log --oneline -1 "${_c}"
    git cherry-pick -n "${_c}"
  done
}

package_x1e-firmware() {
  depends=('initramfs')

  install -Dm644 "${srcdir}/dracut.conf.d-x1e-firmware.conf" "${pkgdir}/etc/dracut.conf.d/x1e-firmware.conf"
  install -Dt "${pkgdir}/usr/share/licenses/${pkgname}" -m644 ${_srcdir}/WHENCE

  mkdir -pv "${pkgdir}"/usr/lib/firmware
  cp -rv "${_srcdir}"/qca "${pkgdir}"/usr/lib/firmware
  cp -rv "${_srcdir}"/qcom "${pkgdir}"/usr/lib/firmware
  cp -rv "${_srcdir}"/ath12k "${pkgdir}"/usr/lib/firmware
  cp -rv "${_srcdir}"/rtl_nic "${pkgdir}"/usr/lib/firmware

  cd x1e-firmware

  make DEST="${pkgdir}"/usr/lib install
}

